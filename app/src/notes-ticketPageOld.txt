<template>
	<section>
		<div v-if="loading">...</div> 
		<div v-else class="ticket"> 
			<h1 v-if="!editMode">Create a Ticket for bug</h1>
			<h1 v-else>Update your Ticket</h1>
			
			<div class="ticket__container">
				<form>
					<section>
						<label for="title">Title</label>
						<input id="title" name="title" type="text" v-model="formData.title"/>

						<label for="description">Description</label> 
                    	<textarea id="description" name="description" rows="3" cols="20" type="text" v-model="formData.description"></textarea>

						<label for="team">Team</label>
						<select id="team" name="team" v-model="formData.team">
							<option v-for="team in result" :key="team._id" :value="team.name">{{ `${team.name}` }}</option>
						</select>

						<label for="new-team">New Team</label>
						<input id="new-team" name="new-team" type="text" v-model="formData.team">

						<label for="priority">Priority</label>
						<select id="priority" name="priority" v-model="formData.priority">
							<option value="major">Major</option>
							<option value="low">Low</option>
							<option value="critical">Critical</option>
						</select>

						<div>
							<label for="progress">Progress</label>
							<input type="range" id="progress" name="progress" v-model.number="formData.progress" min="0" max=100>
							
							<label for="status">Status</label>
							<select id="status" name="status" v-model="formData.status">
								<option value="not started">Not started yet</option>
								<option value="working on it">Working on it</option>
								<option value="stuck">Stuck</option>
								<option value="done">Done</option>
							</select>
						</div>

						<input type="submit" @click.prevent="handleSubmit">
					</section>

					<section>
						<label for="reporter">Reporter</label>
						<input id="reporter" name="reporter" type="text" v-model="formData.reporter">

						<label for="reporterImage">Reporter Image</label>
						<input id="reporterImage" name="reporterImage" type="text" v-model="formData.reporterImage">

						<!-- <div class="reporter-image">
							<img v-if="formData.reporterImage" :src="formData.reporterImage" alt="Reporter image">
						</div> -->

						<label for="assignee">Assignee</label>
						<input id="assignee" name="assignee" type="text" v-model="formData.assignee">

						<label for="assigneeImage">Assignee Image</label>
						<input id="assigneeImage" name="assigneeImage" type="text" v-model="formData.assigneeImage">

						<!-- <div class="assignee-image">
							<img v-if="formData.assigneeImage" :src="formData.assigneeImage" alt="Assignee image">
						</div> -->

						<label for="submitDate">Submit Date:</label>
  						<input type="date" id="submitDate" name="submitDate" v-model="formData.submitDate">
					</section>
				</form>
			</div>
		</div>	
	</section>
</template>

<script> 
	import sanity from '../sanity.js';
	import query from '../groq/team.groq?raw';
	import viewMixin from '../mixins/viewMixin.js';
	export default {
		mixins: [viewMixin],

		data() {
			return {
				editMode: false,
				formData: {
					title:'',
					description: '',
					priority: '',
					status: '',
					progress: 0,
					submitDate: '',
					team: '',
					reporter: '',
					assignee: '',
				},
				teamID: '',
				reporterID: '',
				assigneeID: '',
			}
		},

		async created() {
			await this.sanityFetch(query, { 
				type: 'team' 
			});
		},

		methods: {
			handleSubmit() {
				this.teamID = this.result.find(team => team.name === this.formData.team );
				const teamIndex = this.result.findIndex(team => team.name === this.formData.team)
				if(teamIndex === 1) {
					const team = {
						_id: this.teamID._id,
						_type: 'team',
						name: this.formData.team,
					}
					sanity.createIfNotExists(team).then((res) => {
						this.teamID = res._id;

						const reporter = {
							_type: 'person',
							name: this.formData.reporter,
						}
						sanity.create(reporter).then((res) => {
							this.reporterID = res._id;

							const assignee = {
							_type: 'person',
							name: this.formData.assignee,
							}
							sanity.create(assignee).then((res) => {
								this.assigneeID = res._id;
								this.createBug();
							});
						});
					});		
				} else {
					const team = {
						_type: 'team',
						name: this.formData.team,
					}
					sanity.create(team).then((res) => {
						this.teamID = res._id;

						const reporter = {
							_type: 'person',
							name: this.formData.reporter,
						}
						sanity.create(reporter).then((res) => {
							this.reporterID = res._id;

							const assignee = {
							_type: 'person',
							name: this.formData.assignee,
							}
							sanity.create(assignee).then((res) => {
								this.assigneeID = res._id;
								this.createBug();
							});
						});
					});		
				}
					
			},

			createBug() {
				sanity.create({
					_type: 'bug',
					title: this.formData.title,
					description: this.formData.description,
					priority: this.formData.priority,
					status: this.formData.status,
					progress: this.formData.progress,
					submitDate: this.formData.submitDate,
					team: {
						_type: 'reference',
						_ref: this.teamID,
					},
					reporter: {
						_type: 'reference',
						_ref: this.reporterID,
					},
					assignee: {
						_type: 'reference',
						_ref: this.assigneeID,
					}
				})
				
				.then(result => {
					console.log(`Created book with id: ${result._id}`)
				});
			},
		},
	}
</script>

<template>
	<section>
		<div v-if="loading">...</div> 
		<div v-else class="ticket" v-for="bug in result" :key="bug._id"> 
			<h1>{{ bug.title }}</h1>
			
			<div class="ticket__container">
				<form>
					<section>
                        <label for="reporter">Reporter</label>
						<input id="reporter" name="reporter" type="text" v-model="bugData.reporter">
                        <!-- <input v-if="bug.reporter !== null " id="reporter" name="reporter" type="text" v-model="bug.reporter.name"> -->
						<!-- <input v-else id="reporter" name="reporter" type="text" v-model="bugData.reporter"> -->

                        <label for="assignee">Assignee</label>
						<select id="assignee" name="assignee" v-model="bugData.assignee">
							<option v-for="projectMember in bug.project.projectMembers" :key="projectMember._id" :value="projectMember.name">{{ `${projectMember.name}` }}</option>
						</select>
						<!-- <select v-if="bug.assignee !== null" id="assignee" name="assignee" v-model="bug.assignee.name">
							<option v-for="projectMember in bug.project.projectMembers" :key="projectMember._id" :value="projectMember.name">{{ `${projectMember.name}` }}</option>
						</select>

                        <select v-else id="assignee" name="assignee" v-model="bugData.assignee">
							<option v-for="projectMember in bug.project.projectMembers" :key="projectMember._id" :value="projectMember.name">{{ `${projectMember.name}` }}</option>
						</select> -->

                        <label for="dueDate">Due Date:</label>
						<input type="date" id="dueDate" name="dueDate" v-model="bugData.dueDate">
						<!-- <input v-if="bug.dueDate" type="date" id="dueData" name="dueDate" v-model="bug.date">
                        <input v-else type="date" id="dueDate" name="dueDate" v-model="bugData.dueDate"> -->

                        <label for="description">Description</label> 
						<textarea id="description" name="description" rows="4" cols="20" type="text" v-model="bugData.description"></textarea>
                    	<!-- <textarea v-if="bug.description" id="description" name="description" rows="4" cols="20" type="text" v-model="bug.description"></textarea>
						<textarea v-else id="description" name="description" rows="4" cols="20" type="text" v-model="bugData.description"></textarea> -->

                        <!-- <label for="screenshot">Screenshot</label>
                        <input type="text" id="screenshot" name="screenshot" v-model="bugData.screenshot"> -->

						<label for="priority">Priority</label>
						<select id="priority" name="priority" v-model="bugData.priority">
							<option value="high">High</option>
							<option value="medium">Medium</option>
							<option value="low">Low</option>
							<option value="critical">Critical</option>
						</select>
						<!-- <select v-if="bug.priority" id="priority" name="priority" v-model="bug.priority">
							<option value="high">High</option>
							<option value="medium">Medium</option>
							<option value="low">Low</option>
							<option value="critical">Critical</option>
						</select> -->

						<!-- <select v-else id="priority" name="priority" v-model="bugData.priority">
							<option value="high">High</option>
							<option value="medium">Medium</option>
							<option value="low">Low</option>
							<option value="critical">Critical</option>
						</select> -->

							<!-- <label for="progress">Progress</label> -->
							<!-- <input type="range" id="progress" name="progress" v-model.number="bug.progress" min="0" max=100> -->
							
						<label for="status">Status</label>
						<select id="status" name="status" v-model="bugData.status">
							<option value="not started yet">Not started yet</option>
							<option value="working on it">Working on it</option>
							<option value="stuck">Stuck</option>
							<option value="done">Done</option>
						</select>
						<!-- <select v-if="bug.status" id="status" name="status" v-model="bug.status">
							<option value="not started yet">Not started yet</option>
							<option value="working on it">Working on it</option>
							<option value="stuck">Stuck</option>
							<option value="done">Done</option>
						</select> -->

						<!-- <select v-else id="status" name="status" v-model="bugData.status">
							<option value="not started yet">Not started yet</option>
							<option value="working on it">Working on it</option>
							<option value="stuck">Stuck</option>
							<option value="done">Done</option>
						</select> -->
                            
						
                        <input type="submit" @click.prevent="handleSubmit">
					</section>
				</form>
			</div>
		</div>	
	</section>
</template>

<script> 
	import sanity from '../sanity.js';
	import query from '../groq/ticketPage.groq?raw';
	import viewMixin from '../mixins/viewMixin.js';
	export default {
		mixins: [viewMixin],

		data() {
			return {
				bugData: {
					description: '',
					priority: '',
					status: '',
					dueDate: '',
					reporter: '',
					assignee: '',
				},
				reporterID: '',
				assigneeID: '',
				projectMemberID: '',
			}
		},

		async created() {
			await this.sanityFetch(query, { 
				slug: this.$route.params.ticketSlug 
			});
			this.handleBugData();
		},

		methods: {
			handleBugData() {
				// result[0].assignee = this.bugData.assignee
				console.log(this.result[0].description)
				this.result.map(bug => {
					if(bug.reporter === null) {
						this.bugData.reporter = ''
					} else {
						this.bugData.reporter = bug.reporter.name
					}
					
					if(bug.assignee === null) {
						this.bugData.assignee = ''
					} else {
						this.bugData.assignee = bug.assignee.name;
					}
					
					this.bugData.dueDate = bug.dueDate;
					this.bugData.description = bug.description;
					this.bugData.priority = bug.priority;
					this.bugData.status = bug.status;
					
				})
				console.log(this.bugData)
			},
			handleSubmit() {
				console.log(this.bugData.assignee)
				// console.log(this.bugData.assignee)
				// console.log(this.result[0])
				this.projectMemberID = this.result[0].project.projectMembers.find(member => member.name === this.bugData.assignee);
				// console.log(this.projectMemberID)
				// const projectIndex = this.result[0].project.projectMembers.findIndex(project => project.name === this.bugData.assignee)
				// console.log(projectIndex)
				// // if(projectIndex > 0) {
					const assignee = {
							_id: this.projectMemberID._id,
							_type: 'employee',
							name: this.bugData.assignee,
						}
					sanity.createIfNotExists(assignee).then((res) => {
						this.assigneeID = res._id;
						this.updateBug();
					});

					// console.log(this.result[0]._id)
					// console.log(this.bugData.assignee)
				// } else {
				// 	const assignee = {
				// 			_type: 'employee',
				// 			name: this.bugData.assignee,
				// 		}
				// 	sanity.create(assignee).then((res) => {
				// 		this.assigneeID = res._id;
						this.updateBug();
				// 	});
				// }
			},

			updateBug() {
				sanity
					.patch(this.result[0]._id)
					.set({ assignee: {
								_type: 'reference',
								_ref: this.projectMemberID._id,
							}, 
						})
					.set({ description: this.bugData.description, })
					.set({ priority: this.bugData.priority, })
					.set({ status: this.bugData.status, })
					.set({ dueDate: this.bugData.dueDate, })
					.commit()
					.then(updatedDocument => {
						console.log('I just updated document:', updatedDocument);
					});
			}	
		},
	}
</script>

<style>
	.ticket {
		padding: 30px;
		width: 100%;
	}

	.ticket__container {
		width: 100%;
		display: flex;
		justify-content: center;
	}

	.ticket__container form {
		display: flex;
	}

	.ticket__container form section {
		display: flex;
		flex-direction: column;
		margin: 10px;
		width: 500px;
	}

	.ticket__container form label {
		margin: 20px 0 0 0;	
	}

	.ticket__container form select,
	.ticket__container form input {
		padding: 10px;
		font-size: 15px;
		border-radius: 10px;
		border: 1.5px solid rgb(218, 218, 218);
		margin: 5px;
	}

	.ticket__container-multiple-input-container {
		margin: 20px 0 20px 0;
	}
</style>